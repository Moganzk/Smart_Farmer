# ==============================================================================
# Smart Farmer - Release APK
# ==============================================================================
# Runs on: Tags matching v*.*.* (e.g., v1.0.0, v2.1.3)
# Jobs: Build release APK, Create GitHub Release, Attach APK artifact
# ==============================================================================

name: Release APK

on:
  push:
    tags:
      - "v*.*.*"

env:
  FLUTTER_VERSION: "3.27.0"

jobs:
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: smart_farmer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          dart --version

      - name: Get dependencies
        run: flutter pub get

      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          WEATHER_PROVIDER=${{ secrets.WEATHER_PROVIDER }}
          GOOGLE_WEATHER_API_KEY=${{ secrets.GOOGLE_WEATHER_API_KEY }}
          WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
          EOF

      - name: Run tests
        run: flutter test

      - name: Build Release APK
        run: flutter build apk --release

      - name: Rename APK with version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/smart-farmer-$VERSION.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Smart Farmer ${{ github.ref_name }}
          body: |
            ## Smart Farmer ${{ github.ref_name }}
            
            ### ðŸ“± Download
            Download the APK below and install on your Android device.
            
            ### ðŸ“‹ Changelog
            See [CHANGELOG.md](CHANGELOG.md) for details.
            
            ---
            *Built with Flutter ${{ env.FLUTTER_VERSION }}*
          files: |
            smart_farmer/build/app/outputs/flutter-apk/smart-farmer-*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: smart_farmer/build/app/outputs/flutter-apk/smart-farmer-*.apk
          retention-days: 90
